//>>built
define("kso/Store","dojo/_base/declare,dojo/topic,dojo/_base/config,dojo/store/Memory,dojo/store/Observable,dojo/store/JsonRest,dojo/_base/Deferred,dojo/store/util/QueryResults".split(","),function(i,d,g,j,k,l,m,n){var h="/service";if("string"==typeof g.service_uri)h=g.service_uri;return i(null,{entity_name:null,constructor:function(a){for(var b in a)this[b]=a[b];this._store=k(new j);this._rest_store=new l({target:h+"/entity/"+this.entity_name+"/"});this._need_sync=!0;this._updates=[];this._removes=
[];this._inserts=[];var c=this;d.subscribe("moch/entity_update",function(a,b,e){if(c.entity_name==a)e.id=b,c._store.put(e)});d.subscribe("moch/entity_create",function(a,b){if(c.entity_name==a)try{c._store.get(b.id)||c._store.add(b)}catch(e){}});d.subscribe("moch/entity_delete",function(a,b){c.entity_name==a&&c._store.get(b)&&c._store.remove(b)})},get:function(a){return this._store.get(a)},getIdentity:function(a){return this._store.getIdentity(a)},put:function(a){this._updates.push(a);this._start_update_data()},
add:function(a){this._inserts.push(a);this._start_update_data()},remove:function(a){this._removes.push(a);this._start_update_data()},query:function(a,b){return this._need_sync?this._fetch_data(a,b):this._store.query(a,b)},_fetch_data:function(a,b){if(this._need_sync){var c=new m,f=this,d=this._rest_store.query(a,b),e=n(c);d.then(function(d){f._store.setData(d);f._need_sync=!1;d=f._store.query(a,b);e.observe=d.observe;c.resolve(d)},function(){setTimeout(f._fetch_data,6E5)});return e}},_start_update_data:function(){this._thndl&&
clearTimeout(this._thndl);this._update_data()},_update_data:function(){if(0==this._updates.length&&0==this._inserts.length&&0==this._removes.length)this._thndl=void 0;else{var a=this;this._updates.forEach(function(b){a._rest_store.put(b).then(function(){},function(){this._updates.push(b)})});this._updates=[];this._inserts.forEach(function(b){delete b.id;a._rest_store.add(b).then(function(){},function(){a._inserts.push(b)})});a._inserts=[];this._removes.forEach(function(b){a._rest_store.remove(b).then(function(){},
function(){a._removes.push(b)})});this._removes=[];this._thndl=setTimeout(function(){a._update_data.apply(a)},6E5)}}})});